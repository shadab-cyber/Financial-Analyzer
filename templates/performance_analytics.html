<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Performance Analytics - Production</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>


<style>
/* Base responsive styles */
body { font-family: Arial, sans-serif; }

/* Section cards */
.section-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
}

.section-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #1e40af;
    margin-bottom: 16px;
}

.metric-card {
    background: #f9fafb;
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    border-left: 4px solid #3b82f6;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

/* Table responsive */
table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    border: 1px solid #e5e7eb;
    padding: 12px;
    text-align: left;
}

th {
    background: #f3f4f6;
    font-weight: bold;
}

.positive { color: #10b981; font-weight: bold; }
.negative { color: #ef4444; font-weight: bold; }

/* Tabs */
.tab-button {
    padding: 12px 24px;
    border: none;
    background: #e5e7eb;
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    margin-right: 4px;
    font-weight: 600;
    transition: all 0.3s;
}

.tab-button.active {
    background: #3b82f6;
    color: white;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* ============================================ */
/* MOBILE RESPONSIVE STYLES */
/* ============================================ */

/* Wrap tables in scrollable container */
.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 10px 0;
}

table {
    min-width: 600px;
}

/* Mobile optimizations */
@media (max-width: 768px) {
    /* Reduce padding */
    .section-card {
        padding: 16px;
        margin-bottom: 16px;
    }
    
    .metric-card {
        padding: 12px;
    }
    
    /* Typography scaling */
    h1 {
        font-size: 1.75rem !important;
    }
    
    .section-title {
        font-size: 1.25rem !important;
    }
    
    h2 {
        font-size: 1.5rem !important;
    }
    
    h3 {
        font-size: 1.125rem !important;
    }
    
    /* Force single column on mobile */
    .grid {
        grid-template-columns: 1fr !important;
    }
    
    /* Tab buttons stack on mobile */
    .flex.justify-center.gap-4 {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .tab-button {
        width: 100%;
        margin: 0;
        margin-bottom: 0.5rem;
        padding: 14px;
        border-radius: 8px;
    }
    
    /* Chart containers */
    .chart-container {
        height: 250px;
    }
    
    /* Smaller metric cards font */
    .metric-card .text-2xl {
        font-size: 1.5rem !important;
    }
    
    .metric-card .text-3xl {
        font-size: 1.75rem !important;
    }
    
    /* Period returns grid - 2 columns on mobile */
    #periodReturns {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

/* Extra small devices */
@media (max-width: 640px) {
    body {
        padding: 0 !important;
    }
    
    .max-w-7xl {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    .section-card {
        padding: 12px;
        border-radius: 12px;
    }
    
    /* Even smaller charts on tiny screens */
    .chart-container {
        height: 200px;
    }
}

/* Touch-friendly buttons */
button, .btn, input[type="submit"], a[class*="btn"] {
    min-height: 44px;
    min-width: 44px;
    touch-action: manipulation;
}

/* Input fields touch-friendly */
input, textarea, select {
    min-height: 44px;
    font-size: 16px; /* Prevents zoom on iOS */
}
</style>

</head>

<body class="bg-gray-100 min-h-screen">

<!-- ================= MOBILE-RESPONSIVE NAVBAR ================= -->
<nav class="text-white shadow-md mb-8" style="background-color:#457b9d;">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      
      <!-- Logo -->
      <div class="flex-shrink-0">
        <a href="/" class="text-xl font-bold">üíº Financial Analyzer</a>
      </div>

      <!-- Desktop Menu -->
      <div class="hidden lg:flex space-x-2">
        <a href="/" 
           class="nav-link px-3 py-2 rounded-lg text-sm hover:bg-white hover:bg-opacity-20 transition">
          Home
        </a>
        <a href="/dcf" 
           class="nav-link px-3 py-2 rounded-lg text-sm hover:bg-white hover:bg-opacity-20 transition">
          DCF
        </a>
        <a href="/financial-modelling" 
           class="nav-link px-3 py-2 rounded-lg text-sm hover:bg-white hover:bg-opacity-20 transition">
          Modelling
        </a>
        <a href="/technical-analysis" 
           class="nav-link px-3 py-2 rounded-lg text-sm hover:bg-white hover:bg-opacity-20 transition">
          Technical
        </a>
        <a href="/portfolio-management" 
           class="nav-link px-3 py-2 rounded-lg text-sm hover:bg-white hover:bg-opacity-20 transition">
          Portfolio
        </a>
        <a href="/performance-analytics" 
           class="nav-link px-3 py-2 rounded-lg text-sm hover:bg-white hover:bg-opacity-20 transition">
          Performance
        </a>
        <a href="/strategy-optimization" 
           class="nav-link px-3 py-2 rounded-lg text-sm hover:bg-white hover:bg-opacity-20 transition">
          Strategy
        </a>
      </div>

      <!-- Mobile menu button -->
      <div class="lg:hidden">
        <button id="mobile-menu-btn" type="button" 
                class="inline-flex items-center justify-center p-2 rounded-md hover:bg-white hover:bg-opacity-20 focus:outline-none">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path id="menu-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            <path id="close-icon" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class="hidden lg:hidden">
    <div class="px-2 pt-2 pb-3 space-y-1">
      <a href="/" 
         class="block px-3 py-2 rounded-md text-base hover:bg-white hover:bg-opacity-20 transition">
        üè† Home
      </a>
      <a href="/dcf" 
         class="block px-3 py-2 rounded-md text-base hover:bg-white hover:bg-opacity-20 transition">
        üìä DCF Valuation
      </a>
      <a href="/financial-modelling" 
         class="block px-3 py-2 rounded-md text-base hover:bg-white hover:bg-opacity-20 transition">
        üìà Financial Modelling
      </a>
      <a href="/technical-analysis" 
         class="block px-3 py-2 rounded-md text-base hover:bg-white hover:bg-opacity-20 transition">
        üìâ Technical Analysis
      </a>
      <a href="/portfolio-management" 
         class="block px-3 py-2 rounded-md text-base hover:bg-white hover:bg-opacity-20 transition">
        üíº Portfolio Management
      </a>
      <a href="/performance-analytics" 
         class="block px-3 py-2 rounded-md text-base hover:bg-white hover:bg-opacity-20 transition">
        üìä Performance Analytics
      </a>
      <a href="/strategy-optimization" 
         class="block px-3 py-2 rounded-md text-base hover:bg-white hover:bg-opacity-20 transition">
        üéØ Strategy Optimization
      </a>
    </div>
  </div>
</nav>

<script>
// Mobile menu toggle
document.addEventListener('DOMContentLoaded', function() {
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');

  if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', function() {
      mobileMenu.classList.toggle('hidden');
      menuIcon.classList.toggle('hidden');
      closeIcon.classList.toggle('hidden');
    });
  }

  // Highlight active page
  const currentPath = window.location.pathname;
  document.querySelectorAll('.nav-link, #mobile-menu a').forEach(link => {
    if (link.getAttribute('href') === currentPath) {
      link.classList.add('bg-white', 'bg-opacity-20', 'font-semibold');
    }
  });
});
</script>
<!-- =============== NAVBAR END =============== -->


<!-- MAIN CONTAINER -->
<div class="max-w-7xl mx-auto px-6">
  
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">üìä Performance Analytics</h1>
    <p class="text-gray-600">Institutional-grade portfolio performance analysis</p>
  </div>

  <!-- Data Source Selection -->
  <div class="section-card">
    <div class="text-center">
      <h3 class="text-lg font-bold text-gray-800 mb-4">üìÅ Select Data Source</h3>
      
      <div class="flex justify-center gap-4 mb-6">
        <button onclick="switchTab('portfolio')" id="tabPortfolio" class="tab-button active">
          üíº From Portfolio Management
        </button>
        <button onclick="switchTab('manual')" id="tabManual" class="tab-button">
          üìù Manual Data Entry
        </button>
        <button onclick="switchTab('upload')" id="tabUpload" class="tab-button">
          üì§ Upload CSV
        </button>
      </div>

      <!-- Tab 1: Portfolio Management Integration -->
      <div id="contentPortfolio" class="tab-content active">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
          <h4 class="font-semibold text-blue-800 mb-3">üîó Connect to Portfolio Management</h4>
          <p class="text-gray-700 mb-4">
            Automatically fetch your portfolio data from Portfolio Management page.
          </p>
          
          <div class="bg-white rounded p-4 mb-4">
            <p class="text-sm text-gray-600 mb-2">Status: <span id="portfolioStatus" class="font-bold text-orange-600">Not Connected</span></p>
            <p class="text-sm text-gray-600 mb-2">Last Analysis: <span id="lastAnalysis">Never</span></p>
            <p class="text-xs text-gray-500 mt-3 p-2 bg-blue-50 border-l-4 border-blue-400 rounded">
              <strong>üí° How it works:</strong><br>
              1. Go to <a href="/portfolio-management" class="text-blue-600 underline">Portfolio Management</a><br>
              2. Add your holdings and click "Analyze Portfolio"<br>
              3. Return here and click "Fetch Portfolio Data & Analyze"
            </p>
          </div>

          <button onclick="fetchFromPortfolio()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition shadow-md">
            üìä Fetch Portfolio Data & Analyze
          </button>
          
          <p class="text-xs text-gray-500 mt-3">
            Note: You must have active holdings in Portfolio Management
          </p>
        </div>
      </div>

      <!-- Tab 2: Manual Entry -->
      <div id="contentManual" class="tab-content">
        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
          <h4 class="font-semibold text-green-800 mb-4">‚úçÔ∏è Enter Portfolio Data Manually</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Initial Investment (‚Çπ)</label>
              <input type="number" id="initialValue" placeholder="517050" 
                class="w-full border border-gray-300 rounded px-4 py-2">
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Current Value (‚Çπ)</label>
              <input type="number" id="currentValue" placeholder="662800" 
                class="w-full border border-gray-300 rounded px-4 py-2">
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Investment Date</label>
              <input type="date" id="investmentDate" 
                class="w-full border border-gray-300 rounded px-4 py-2">
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Number of Holdings</label>
              <input type="number" id="numHoldings" placeholder="5" min="1"
                class="w-full border border-gray-300 rounded px-4 py-2">
            </div>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Additional Cash Flows (Optional)</label>
            <textarea id="cashFlows" rows="3" placeholder="Format: YYYY-MM-DD,Amount (one per line)
Example:
2024-01-15,100000
2024-06-20,50000" 
              class="w-full border border-gray-300 rounded px-4 py-2"></textarea>
          </div>

          <button onclick="analyzeManualData()" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition shadow-md">
            üìä Analyze Manual Data
          </button>
        </div>
      </div>

      <!-- Tab 3: Upload CSV -->
      <div id="contentUpload" class="tab-content">
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
          <h4 class="font-semibold text-purple-800 mb-4">üì§ Upload Portfolio History CSV</h4>
          
          <div class="bg-white rounded p-4 mb-4 text-left">
            <p class="text-sm font-semibold text-gray-700 mb-2">CSV Format Required:</p>
            <pre class="text-xs bg-gray-100 p-3 rounded overflow-x-auto">date,total_value
2024-01-01,517050
2024-01-02,519200
2024-01-03,522100
...</pre>
          </div>

          <div class="mb-4">
            <input type="file" id="csvFile" accept=".csv" 
              class="w-full border border-gray-300 rounded px-4 py-2">
          </div>

          <button onclick="analyzeCSVData()" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-semibold transition shadow-md">
            üìä Upload & Analyze CSV
          </button>
          
          <a href="#" onclick="downloadSampleCSV()" class="block mt-3 text-sm text-purple-600 hover:underline">
            üì• Download Sample CSV Template
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loadingIndicator" class="hidden text-center py-8">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    <p class="text-gray-600 mt-4">Analyzing performance...</p>
  </div>

  <!-- Error Display -->
  <div id="errorContainer" class="hidden">
    <div class="section-card bg-red-50 border-2 border-red-300">
      <div class="flex items-start gap-3">
        <span class="text-3xl">‚ö†Ô∏è</span>
        <div>
          <h3 class="text-lg font-bold text-red-800 mb-2">Error</h3>
          <p id="errorMessage" class="text-red-700"></p>
          <button onclick="hideError()" class="mt-3 text-sm text-red-600 hover:underline">Dismiss</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Container -->
  <div id="resultsContainer" class="hidden">
    
    <!-- Results Header -->
    <div class="section-card bg-gradient-to-r from-blue-500 to-purple-600 text-white">
      <div class="text-center">
        <h2 class="text-2xl font-bold mb-2">‚úÖ Analysis Complete!</h2>
        <p class="text-blue-100">Your comprehensive performance report is ready</p>
        <p class="text-sm text-blue-200 mt-2">Analysis Date: <span id="analysisDate"></span></p>
      </div>
    </div>

    <!-- 1. OVERALL PERFORMANCE -->
    <div class="section-card">
      <div class="section-title">üß† Overall Portfolio Performance</div>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="metric-card border-l-4 border-green-500">
          <div class="text-sm text-gray-600">Total Return</div>
          <div id="totalReturn" class="text-2xl font-bold text-green-600">--</div>
          <div id="totalReturnAmount" class="text-sm text-gray-500">--</div>
        </div>
        <div class="metric-card border-l-4 border-blue-500">
          <div class="text-sm text-gray-600">CAGR</div>
          <div id="cagr" class="text-2xl font-bold text-blue-600">--</div>
          <div class="text-sm text-gray-500">Annualized</div>
        </div>
        <div class="metric-card border-l-4 border-purple-500">
          <div class="text-sm text-gray-600">XIRR</div>
          <div id="xirr" class="text-2xl font-bold text-purple-600">--</div>
          <div class="text-sm text-gray-500">Money-weighted</div>
        </div>
        <div class="metric-card border-l-4 border-orange-500">
          <div class="text-sm text-gray-600">Current Value</div>
          <div id="currentValueDisplay" class="text-2xl font-bold text-orange-600">--</div>
          <div id="initialValue" class="text-sm text-gray-500">--</div>
        </div>
      </div>

      <!-- Period-wise Returns -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3">Period-wise Returns</h3>
        <div class="grid grid-cols-3 md:grid-cols-5 gap-3" id="periodReturns"></div>
      </div>

      <!-- Best/Worst Days -->
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-green-50 rounded p-3">
          <div class="text-sm text-gray-600">Best Day</div>
          <div id="bestDay" class="font-bold text-green-700">--</div>
        </div>
        <div class="bg-red-50 rounded p-3">
          <div class="text-sm text-gray-600">Worst Day</div>
          <div id="worstDay" class="font-bold text-red-700">--</div>
        </div>
      </div>

      <!-- Equity Curve -->
      <div>
        <h3 class="text-lg font-semibold mb-3">Equity Curve</h3>
        <div class="chart-container">
          <canvas id="equityCurveChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 2. RISK-ADJUSTED PERFORMANCE -->
    <div class="section-card">
      <div class="section-title">üìâ Risk-Adjusted Performance</div>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="metric-card">
          <div class="text-xs text-gray-600">Sharpe Ratio</div>
          <div id="sharpeRatio" class="text-2xl font-bold text-gray-800">--</div>
          <div class="text-xs text-gray-500">Risk-adjusted return</div>
        </div>
        <div class="metric-card">
          <div class="text-xs text-gray-600">Sortino Ratio</div>
          <div id="sortinoRatio" class="text-2xl font-bold text-gray-800">--</div>
          <div class="text-xs text-gray-500">Downside risk</div>
        </div>
        <div class="metric-card">
          <div class="text-xs text-gray-600">Calmar Ratio</div>
          <div id="calmarRatio" class="text-2xl font-bold text-gray-800">--</div>
          <div class="text-xs text-gray-500">Return/Drawdown</div>
        </div>
        <div class="metric-card">
          <div class="text-xs text-gray-600">Volatility</div>
          <div id="volatility" class="text-2xl font-bold text-gray-800">--</div>
          <div class="text-xs text-gray-500">Annualized</div>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
        <div class="metric-card">
          <div class="text-xs text-gray-600">Max Drawdown</div>
          <div id="maxDrawdown" class="text-2xl font-bold text-red-600">--</div>
          <div class="text-xs text-gray-500">Peak to trough</div>
        </div>
        <div class="metric-card">
          <div class="text-xs text-gray-600">VaR (95%)</div>
          <div id="var95" class="text-2xl font-bold text-orange-600">--</div>
          <div class="text-xs text-gray-500">Daily risk</div>
        </div>
        <div class="metric-card">
          <div class="text-xs text-gray-600">CVaR (95%)</div>
          <div id="cvar95" class="text-2xl font-bold text-red-600">--</div>
          <div class="text-xs text-gray-500">Tail risk</div>
        </div>
      </div>
    </div>

    <!-- 3. BENCHMARK COMPARISON -->
    <div class="section-card">
      <div class="section-title">üéØ Benchmark Comparison (vs NIFTY 50)</div>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="metric-card border-l-4 border-green-500">
          <div class="text-sm text-gray-600">Your Return</div>
          <div id="portfolioReturn" class="text-2xl font-bold text-green-600">--</div>
        </div>
        <div class="metric-card border-l-4 border-gray-500">
          <div class="text-sm text-gray-600">NIFTY Return</div>
          <div id="benchmarkReturn" class="text-2xl font-bold text-gray-600">--</div>
        </div>
        <div class="metric-card border-l-4 border-blue-500">
          <div class="text-sm text-gray-600">Outperformance</div>
          <div id="outperformance" class="text-2xl font-bold text-blue-600">--</div>
        </div>
        <div class="metric-card border-l-4 border-purple-500">
          <div class="text-sm text-gray-600">Alpha</div>
          <div id="alpha" class="text-2xl font-bold text-purple-600">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
        <div class="metric-card">
          <div class="text-xs text-gray-600">Beta</div>
          <div id="beta" class="text-xl font-bold">--</div>
          <div class="text-xs text-gray-500">Market sensitivity</div>
        </div>
        <div class="metric-card">
          <div class="text-xs text-gray-600">Tracking Error</div>
          <div id="trackingError" class="text-xl font-bold">--</div>
          <div class="text-xs text-gray-500">vs benchmark</div>
        </div>
        <div class="metric-card">
          <div class="text-xs text-gray-600">Info Ratio</div>
          <div id="infoRatio" class="text-xl font-bold">--</div>
          <div class="text-xs text-gray-500">Excess return quality</div>
        </div>
        <div class="metric-card">
          <div class="text-xs text-gray-600">Correlation</div>
          <div id="correlation" class="text-xl font-bold">--</div>
          <div class="text-xs text-gray-500">With NIFTY</div>
        </div>
      </div>
    </div>

    <!-- 4. ATTRIBUTION ANALYSIS -->
    <div class="section-card">
      <div class="section-title">üîç Attribution Analysis (Why Returns Happened)</div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <div class="chart-container" style="height: 250px;">
            <canvas id="attributionChart"></canvas>
          </div>
        </div>
        <div>
          <div class="space-y-3" id="attributionDetails"></div>
        </div>
      </div>
    </div>

    <!-- 5. TRADE-LEVEL PERFORMANCE -->
    <div class="section-card" id="tradeSection">
      <div class="section-title">üìà Trade-Level Performance</div>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="metric-card">
          <div class="text-sm text-gray-600">Win Rate</div>
          <div id="winRate" class="text-2xl font-bold text-green-600">--</div>
          <div id="tradeCount" class="text-xs text-gray-500">--</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Profit Factor</div>
          <div id="profitFactor" class="text-2xl font-bold text-blue-600">--</div>
          <div class="text-xs text-gray-500">Gross profit/loss</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Payoff Ratio</div>
          <div id="payoffRatio" class="text-2xl font-bold text-purple-600">--</div>
          <div class="text-xs text-gray-500">Avg win/loss</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Expectancy</div>
          <div id="expectancy" class="text-2xl font-bold text-orange-600">--</div>
          <div class="text-xs text-gray-500">Per trade</div>
        </div>
      </div>
    </div>

    <!-- 6. DRAWDOWN ANALYSIS -->
    <div class="section-card">
      <div class="section-title">üîª Drawdown & Recovery Analysis</div>
      
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
        <div class="metric-card">
          <div class="text-sm text-gray-600">Max Drawdown</div>
          <div id="maxDD" class="text-2xl font-bold text-red-600">--</div>
          <div id="maxDDDate" class="text-xs text-gray-500">--</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Avg Drawdown</div>
          <div id="avgDD" class="text-2xl font-bold text-orange-600">--</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Current Drawdown</div>
          <div id="currentDD" class="text-2xl font-bold">--</div>
          <div class="text-xs text-gray-500">--</div>
        </div>
      </div>

      <div>
        <h3 class="text-lg font-semibold mb-3">Drawdown Chart</h3>
        <div class="chart-container">
          <canvas id="drawdownChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 7. CONSISTENCY METRICS -->
    <div class="section-card">
      <div class="section-title">‚öñÔ∏è Consistency Metrics</div>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="metric-card">
          <div class="text-sm text-gray-600">Profitable Months</div>
          <div id="profitableMonths" class="text-2xl font-bold text-green-600">--</div>
          <div id="profitableMonthsPct" class="text-xs text-gray-500">--</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Consistency Score</div>
          <div id="consistencyScore" class="text-2xl font-bold text-blue-600">--</div>
          <div class="text-xs text-gray-500">Out of 100</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Monthly Std Dev</div>
          <div id="monthlyStd" class="text-2xl font-bold text-purple-600">--</div>
          <div class="text-xs text-gray-500">Variability</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Return Stability</div>
          <div id="returnStability" class="text-2xl font-bold">--</div>
          <div class="text-xs text-gray-500">Assessment</div>
        </div>
      </div>
    </div>

    <!-- 8. CONTRIBUTION ANALYSIS -->
    <div class="section-card" id="contributionSection">
      <div class="section-title">üéØ Stock Contribution Analysis</div>
      
      <div class="overflow-x-auto"><div class="table-responsive">

        <table id="contributionTable">
          <thead>
            <tr>
              <th>Stock</th>
              <th>Weight %</th>
              <th>Return %</th>
              <th>Return Contribution</th>
              <th>Risk Contribution</th>
            </tr>
          </thead>
          <tbody id="contributionBody"></tbody>
        </table>
</div>
      </div>
    </div>

    <!-- 9. BEHAVIOURAL ANALYTICS -->
    <div class="section-card" id="behavioralSection">
      <div class="section-title">üß† Behavioural Analytics</div>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="metric-card">
          <div class="text-sm text-gray-600">Discipline Score</div>
          <div id="disciplineScore" class="text-3xl font-bold">--</div>
          <div class="text-xs text-gray-500">Out of 100</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Overtrading</div>
          <div id="overtrading" class="text-2xl font-bold">--</div>
          <div class="text-xs text-gray-500">Penalty</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Early Exits</div>
          <div id="earlyExits" class="text-2xl font-bold">--</div>
          <div class="text-xs text-gray-500">Trades</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">Early Exit Cost</div>
          <div id="earlyExitCost" class="text-2xl font-bold">--</div>
          <div class="text-xs text-gray-500">Missed profit</div>
        </div>
      </div>

      <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
        <h4 class="font-semibold text-yellow-800 mb-2">üí° Behavioral Insights</h4>
        <ul id="behavioralInsights" class="list-disc list-inside text-sm text-gray-700 space-y-1"></ul>
      </div>
    </div>

    <!-- 10. STRESS TESTING -->
    <div class="section-card">
      <div class="section-title">üß™ Stress Testing & Scenario Analysis</div>
      
      <div class="overflow-x-auto"><div class="table-responsive">

        <table id="stressTable">
          <thead>
            <tr>
              <th>Scenario</th>
              <th>Current Value</th>
              <th>Stressed Value</th>
              <th>Loss Amount</th>
              <th>Loss %</th>
            </tr>
          </thead>
          <tbody id="stressBody"></tbody>
        </table>
</div>
      </div>
    </div>

    <!-- 11. TWR vs MWR -->
    <div class="section-card">
      <div class="section-title">‚è±Ô∏è Time-Weighted vs Money-Weighted Returns</div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="metric-card border-l-4 border-blue-500">
          <div class="text-sm text-gray-600">Time-Weighted Return (TWR)</div>
          <div id="twr" class="text-2xl font-bold text-blue-600">--</div>
          <div class="text-xs text-gray-500">Portfolio skill</div>
        </div>
        <div class="metric-card border-l-4 border-purple-500">
          <div class="text-sm text-gray-600">Money-Weighted Return (MWR)</div>
          <div id="mwr" class="text-2xl font-bold text-purple-600">--</div>
          <div class="text-xs text-gray-500">Your timing skill</div>
        </div>
        <div class="metric-card border-l-4 border-orange-500">
          <div class="text-sm text-gray-600">Timing Impact</div>
          <div id="timingImpact" class="text-2xl font-bold">--</div>
          <div class="text-xs text-gray-500">--</div>
        </div>
      </div>

      <div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
        <h4 class="font-semibold text-blue-800 mb-2">üìò What This Means</h4>
        <p id="twrExplanation" class="text-sm text-gray-700">--</p>
      </div>
    </div>

    <!-- 12. TAX-ADJUSTED PERFORMANCE -->
    <div class="section-card">
      <div class="section-title">üí∞ Tax-Adjusted Performance</div>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="metric-card border-l-4 border-green-500">
          <div class="text-sm text-gray-600">Pre-Tax Gains</div>
          <div id="preTaxGains" class="text-2xl font-bold text-green-600">--</div>
        </div>
        <div class="metric-card border-l-4 border-orange-500">
          <div class="text-sm text-gray-600">Total Tax</div>
          <div id="totalTax" class="text-2xl font-bold text-orange-600">--</div>
          <div id="taxBreakdown" class="text-xs text-gray-500">--</div>
        </div>
        <div class="metric-card border-l-4 border-blue-500">
          <div class="text-sm text-gray-600">After-Tax Gains</div>
          <div id="afterTaxGains" class="text-2xl font-bold text-blue-600">--</div>
        </div>
        <div class="metric-card border-l-4 border-purple-500">
          <div class="text-sm text-gray-600">Tax Efficiency</div>
          <div id="taxEfficiency" class="text-2xl font-bold text-purple-600">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mt-4">
        <div class="metric-card">
          <div class="text-sm text-gray-600">LTCG (>1 year)</div>
          <div id="ltcgGains" class="text-xl font-bold">--</div>
          <div id="ltcgTax" class="text-xs text-gray-500">--</div>
        </div>
        <div class="metric-card">
          <div class="text-sm text-gray-600">STCG (<1 year)</div>
          <div id="stcgGains" class="text-xl font-bold">--</div>
          <div id="stcgTax" class="text-xs text-gray-500">--</div>
        </div>
      </div>
    </div>

    <!-- Export Options -->
    <div class="section-card">
      <div class="text-center">
        <h3 class="text-lg font-bold text-gray-800 mb-4">üì• Export Report</h3>
        <div class="flex justify-center gap-4">
          <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition">
            üìÑ Export to PDF
          </button>
          <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
            üìä Export to Excel
          </button>
          <button onclick="shareReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
            üì§ Share Report
          </button>
        </div>
      </div>
    </div>

  </div>

</div>

<script>
let equityCurveChart = null;
let drawdownChart = null;
let attributionChart = null;
let analysisData = null;

// Tab switching
function switchTab(tab) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    
    // Show selected tab
    document.getElementById('content' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
    document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

// Fetch from Portfolio Management
async function fetchFromPortfolio() {
    try {
        showLoading();
        hideError();
        
        console.log('Fetching portfolio data from Portfolio Management...');
        
        const response = await fetch('/portfolio-management/get-data', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'Portfolio data not found. Please add holdings in Portfolio Management first.');
        }
        
        const portfolioData = await response.json();
        console.log('Received portfolio data:', portfolioData);
        
        if (!portfolioData || !portfolioData.analysis_result) {
            throw new Error('Invalid portfolio data structure. Please re-analyze your portfolio in Portfolio Management.');
        }
        
        // Transform portfolio data into performance analytics format
        const performanceData = transformPortfolioData(portfolioData);
        console.log('Performance data ready for analysis');
        
        // Analyze
        await analyzePerformance(performanceData);
        
        // Update status
        document.getElementById('portfolioStatus').textContent = 'Connected ‚úÖ';
        document.getElementById('portfolioStatus').className = 'font-bold text-green-600';
        
    } catch (error) {
        hideLoading();
        console.error('Error fetching portfolio:', error);
        
        // Show friendly error with link to Portfolio Management
        const errorMsg = error.message + '<br><br>' +
            '<a href="/portfolio-management" class="text-blue-600 hover:text-blue-800 font-semibold underline">' +
            '‚Üí Go to Portfolio Management to add holdings</a>';
        
        document.getElementById('errorMessage').innerHTML = errorMsg;
        document.getElementById('errorContainer').classList.remove('hidden');
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
}

// Analyze Manual Data
async function analyzeManualData() {
    try {
        const initialVal = parseFloat(document.getElementById('initialValue').value);
        const currentVal = parseFloat(document.getElementById('currentValue').value);
        const investDate = document.getElementById('investmentDate').value;
        const numHoldings = parseInt(document.getElementById('numHoldings').value);
        
        if (!initialVal || !currentVal || !investDate) {
            throw new Error('Please fill in all required fields');
        }
        
        showLoading();
        hideError();
        
        // Parse cash flows
        const cashFlowsText = document.getElementById('cashFlows').value;
        const cashFlows = parseCashFlows(cashFlowsText, investDate, initialVal);
        
        // Generate simulated daily history
        const holdingsHistory = generateHistoryFromManual(initialVal, currentVal, investDate);
        
        const data = {
            holdings_history: holdingsHistory,
            holdings_detail: [],
            cash_flows: cashFlows,
            trades: null,
            signals: null
        };
        
        await analyzePerformance(data);
        
    } catch (error) {
        hideLoading();
        showError(error.message);
    }
}

// Analyze CSV Data
async function analyzeCSVData() {
    try {
        const fileInput = document.getElementById('csvFile');
        
        if (!fileInput.files || !fileInput.files[0]) {
            throw new Error('Please select a CSV file');
        }
        
        showLoading();
        hideError();
        
        const file = fileInput.files[0];
        const text = await file.text();
        const holdingsHistory = parseCSV(text);
        
        const data = {
            holdings_history: holdingsHistory,
            holdings_detail: [],
            cash_flows: [],
            trades: null,
            signals: null
        };
        
        await analyzePerformance(data);
        
    } catch (error) {
        hideLoading();
        showError(error.message);
    }
}

// Main analysis function
async function analyzePerformance(data) {
    try {
        const response = await fetch('/performance-analytics/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Analysis failed');
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Analysis failed');
        }
        
        analysisData = result;
        displayResults(result);
        
        hideLoading();
        document.getElementById('resultsContainer').classList.remove('hidden');
        document.getElementById('portfolioStatus').textContent = 'Connected ‚úÖ';
        document.getElementById('portfolioStatus').className = 'font-bold text-green-600';
        document.getElementById('lastAnalysis').textContent = new Date().toLocaleString();
        document.getElementById('analysisDate').textContent = new Date().toLocaleString();
        
    } catch (error) {
        hideLoading();
        showError(error.message);
    }
}

// Helper Functions
function showLoading() {
    document.getElementById('loadingIndicator').classList.remove('hidden');
    document.getElementById('resultsContainer').classList.add('hidden');
}

function hideLoading() {
    document.getElementById('loadingIndicator').classList.add('hidden');
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorContainer').classList.remove('hidden');
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function hideError() {
    document.getElementById('errorContainer').classList.add('hidden');
}

function parseCashFlows(text, initialDate, initialAmount) {
    const flows = [{date: initialDate, amount: -initialAmount}];
    
    if (text.trim()) {
        const lines = text.trim().split('\n');
        for (let line of lines) {
            const [date, amount] = line.split(',');
            if (date && amount) {
                flows.push({
                    date: date.trim(),
                    amount: -parseFloat(amount.trim())
                });
            }
        }
    }
    
    return flows;
}

function generateHistoryFromManual(initialVal, currentVal, startDate) {
    const history = [];
    const start = new Date(startDate);
    const today = new Date();
    const days = Math.floor((today - start) / (1000 * 60 * 60 * 24));
    
    const totalReturn = (currentVal - initialVal) / initialVal;
    const dailyReturn = Math.pow(1 + totalReturn, 1 / days) - 1;
    
    for (let i = 0; i <= days; i++) {
        const date = new Date(start);
        date.setDate(date.getDate() + i);
        
        const value = initialVal * Math.pow(1 + dailyReturn, i);
        const randomNoise = (Math.random() - 0.5) * 0.01 * value;
        
        history.push({
            date: date.toISOString().split('T')[0],
            total_value: value + randomNoise
        });
    }
    
    // Ensure last value matches current
    history[history.length - 1].total_value = currentVal;
    
    return history;
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',');
    const history = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values.length >= 2) {
            history.push({
                date: values[0].trim(),
                total_value: parseFloat(values[1].trim())
            });
        }
    }
    
    return history;
}

function transformPortfolioData(portfolioData) {
    console.log('Transforming portfolio data:', portfolioData);
    
    // Portfolio Management returns: {holdings, analysis_result, timestamp}
    // Performance Analytics needs: {holdings_history, holdings_detail, cash_flows}
    
    const analysisResult = portfolioData.analysis_result || portfolioData;
    const holdings = analysisResult.holdings || [];
    const summary = analysisResult.summary || {};
    const originalHoldings = portfolioData.holdings || [];
    
    // Generate historical data from current portfolio state
    const holdingsHistory = generatePortfolioHistory(holdings, originalHoldings, summary);
    
    // Generate cash flows from buy transactions
    const cashFlows = generateCashFlows(originalHoldings, holdings);
    
    // Create holdings detail
    const holdingsDetail = holdings.map(h => ({
        symbol: h.symbol,
        quantity: h.quantity,
        current_price: h.current_price,
        current_value: h.current_value,
        gain_loss_pct: h.gain_loss_pct
    }));
    
    console.log('Transformed data:', {
        holdings_history_length: holdingsHistory.length,
        holdings_detail_length: holdingsDetail.length,
        cash_flows_length: cashFlows.length
    });
    
    return {
        holdings_history: holdingsHistory,
        holdings_detail: holdingsDetail,
        cash_flows: cashFlows,
        trades: null,
        signals: null
    };
}

function generatePortfolioHistory(holdings, originalHoldings, summary) {
    // Generate simulated daily historical data based on current portfolio state
    const history = [];
    
    // Find earliest buy date
    let earliestDate = new Date();
    for (const h of originalHoldings) {
        if (h.buy_date && h.buy_date !== 'N/A') {
            const buyDate = new Date(h.buy_date);
            if (buyDate < earliestDate) {
                earliestDate = buyDate;
            }
        }
    }
    
    // If no valid dates, use 1 year ago
    if (earliestDate > new Date()) {
        earliestDate = new Date();
        earliestDate.setFullYear(earliestDate.getFullYear() - 1);
    }
    
    const today = new Date();
    const totalDays = Math.floor((today - earliestDate) / (1000 * 60 * 60 * 24));
    
    // Calculate initial and current values
    const currentValue = summary.total_current_value || 0;
    const investedValue = summary.total_invested || currentValue;
    
    if (investedValue === 0 || totalDays <= 0) {
        // Return minimal history
        return [{
            date: new Date().toISOString().split('T')[0],
            total_value: currentValue
        }];
    }
    
    // Generate daily values with realistic growth
    const totalReturn = (currentValue - investedValue) / investedValue;
    const dailyReturn = Math.pow(1 + totalReturn, 1 / Math.max(totalDays, 1)) - 1;
    
    for (let i = 0; i <= totalDays; i++) {
        const date = new Date(earliestDate);
        date.setDate(date.getDate() + i);
        
        // Calculate value with some randomness
        let value = investedValue * Math.pow(1 + dailyReturn, i);
        
        // Add realistic volatility (¬±1% random daily fluctuation)
        const volatility = 0.01;
        const randomFactor = 1 + (Math.random() - 0.5) * 2 * volatility;
        value = value * randomFactor;
        
        history.push({
            date: date.toISOString().split('T')[0],
            total_value: Math.round(value * 100) / 100
        });
    }
    
    // Ensure last value matches current portfolio value
    if (history.length > 0) {
        history[history.length - 1].total_value = currentValue;
    }
    
    return history;
}

function generateCashFlows(originalHoldings, currentHoldings) {
    const cashFlows = [];
    
    // Create cash flows from buy transactions
    for (const h of originalHoldings) {
        const buyDate = h.buy_date && h.buy_date !== 'N/A' ? h.buy_date : new Date().toISOString().split('T')[0];
        const amount = h.quantity * h.buy_price;
        
        cashFlows.push({
            date: buyDate,
            amount: -amount  // Negative because it's money going out
        });
    }
    
    // Sort by date
    cashFlows.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    return cashFlows;
}

function downloadSampleCSV() {
    const csv = `date,total_value
2024-01-01,517050
2024-01-02,519200
2024-01-03,522100
2024-01-04,520500
2024-01-05,525800`;
    
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'portfolio_history_sample.csv';
    a.click();
}

// Display Results Function (same as demo version)
function displayResults(data) {
    // 1. Overall Performance
    if (data.overall_performance) {
        const op = data.overall_performance;
        document.getElementById('totalReturn').textContent = (op.total_return_pct >= 0 ? '+' : '') + op.total_return_pct + '%';
        document.getElementById('totalReturn').className = 'text-2xl font-bold ' + (op.total_return_pct >= 0 ? 'text-green-600' : 'text-red-600');
        document.getElementById('totalReturnAmount').textContent = '‚Çπ' + op.total_return_amount.toLocaleString();
        document.getElementById('cagr').textContent = op.cagr + '%';
        document.getElementById('xirr').textContent = op.xirr + '%';
        document.getElementById('currentValueDisplay').textContent = '‚Çπ' + op.current_value.toLocaleString();
        document.getElementById('initialValue').textContent = 'From ‚Çπ' + op.initial_value.toLocaleString();
        
        // Period returns
        const periodReturns = document.getElementById('periodReturns');
        periodReturns.innerHTML = Object.entries(op.period_returns).map(([period, value]) => `
            <div class="metric-card">
                <div class="text-xs text-gray-600">${period}</div>
                <div class="text-lg font-bold ${value >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${value >= 0 ? '+' : ''}${value}%
                </div>
            </div>
        `).join('');
        
        // Best/Worst days
        if (op.best_day) {
            document.getElementById('bestDay').textContent = `${op.best_day.date}: +${op.best_day.return.toFixed(2)}%`;
        }
        if (op.worst_day) {
            document.getElementById('worstDay').textContent = `${op.worst_day.date}: ${op.worst_day.return.toFixed(2)}%`;
        }
        
        // Equity curve
        if (data.equity_curve) {
            renderEquityCurve(data.equity_curve);
        }
    }
    
    // 2. Risk-Adjusted
    if (data.risk_adjusted) {
        const ra = data.risk_adjusted;
        document.getElementById('sharpeRatio').textContent = ra.sharpe_ratio || '--';
        document.getElementById('sortinoRatio').textContent = ra.sortino_ratio || '--';
        document.getElementById('calmarRatio').textContent = ra.calmar_ratio || '--';
        document.getElementById('volatility').textContent = ra.volatility ? ra.volatility + '%' : '--';
        document.getElementById('maxDrawdown').textContent = ra.max_drawdown ? ra.max_drawdown + '%' : '--';
        document.getElementById('var95').textContent = ra.var_95 ? ra.var_95 + '%' : '--';
        document.getElementById('cvar95').textContent = ra.cvar_95 ? ra.cvar_95 + '%' : '--';
    }
    
    // 3. Benchmark
    if (data.benchmark_comparison) {
        const bc = data.benchmark_comparison;
        document.getElementById('portfolioReturn').textContent = bc.portfolio_return ? '+' + bc.portfolio_return + '%' : '--';
        document.getElementById('benchmarkReturn').textContent = bc.benchmark_return ? '+' + bc.benchmark_return + '%' : '--';
        document.getElementById('outperformance').textContent = bc.outperformance ? (bc.outperformance >= 0 ? '+' : '') + bc.outperformance + '%' : '--';
        document.getElementById('alpha').textContent = bc.alpha ? (bc.alpha >= 0 ? '+' : '') + bc.alpha + '%' : '--';
        document.getElementById('beta').textContent = bc.beta || '--';
        document.getElementById('trackingError').textContent = bc.tracking_error ? bc.tracking_error + '%' : '--';
        document.getElementById('infoRatio').textContent = bc.information_ratio || '--';
        document.getElementById('correlation').textContent = bc.correlation || '--';
    }
    
    // 4. Attribution
    if (data.attribution) {
        renderAttribution(data.attribution);
    }
    
    // 5. Trade Analysis (hide if no data)
    if (data.trade_analysis) {
        const ta = data.trade_analysis;
        document.getElementById('winRate').textContent = ta.win_rate + '%';
        document.getElementById('tradeCount').textContent = ta.winning_trades + '/' + ta.total_trades + ' trades';
        document.getElementById('profitFactor').textContent = ta.profit_factor;
        document.getElementById('payoffRatio').textContent = ta.payoff_ratio;
        document.getElementById('expectancy').textContent = '‚Çπ' + ta.expectancy.toLocaleString();
    } else {
        document.getElementById('tradeSection').style.display = 'none';
    }
    
    // 6. Drawdown
    if (data.drawdown) {
        const dd = data.drawdown;
        document.getElementById('maxDD').textContent = dd.max_drawdown + '%';
        document.getElementById('maxDDDate').textContent = dd.max_drawdown_date || '--';
        document.getElementById('avgDD').textContent = dd.avg_drawdown + '%';
        document.getElementById('currentDD').textContent = dd.current_drawdown + '%';
        document.getElementById('currentDD').className = 'text-2xl font-bold ' + (dd.current_drawdown === 0 ? 'text-green-600' : 'text-red-600');
        
        if (data.equity_curve) {
            renderDrawdownChart(data.equity_curve);
        }
    }
    
    // 7. Consistency
    if (data.consistency) {
        const cs = data.consistency;
        document.getElementById('profitableMonths').textContent = cs.profitable_months + '/' + cs.total_months;
        document.getElementById('profitableMonthsPct').textContent = cs.pct_profitable_months + '% success';
        document.getElementById('consistencyScore').textContent = cs.consistency_score;
        document.getElementById('monthlyStd').textContent = cs.monthly_std + '%';
        document.getElementById('returnStability').textContent = cs.consistency_score > 75 ? 'High' : cs.consistency_score > 50 ? 'Medium' : 'Low';
    }
    
    // 8. Contribution (hide if no data)
    if (data.contribution && data.contribution.contributions && data.contribution.contributions.length > 0) {
        const contributionBody = document.getElementById('contributionBody');
        contributionBody.innerHTML = data.contribution.contributions.map(c => `
            <tr>
                <td class="font-semibold">${c.symbol}</td>
                <td>${c.weight}%</td>
                <td class="${c.return >= 0 ? 'positive' : 'negative'}">${c.return >= 0 ? '+' : ''}${c.return}%</td>
                <td class="${c.return_contribution >= 0 ? 'positive' : 'negative'}">${c.return_contribution >= 0 ? '+' : ''}${c.return_contribution}%</td>
                <td>${c.risk_contribution}%</td>
            </tr>
        `).join('');
    } else {
        document.getElementById('contributionSection').style.display = 'none';
    }
    
    // 9. Behavioral (hide if no data)
    if (data.behavioral) {
        const bh = data.behavioral;
        document.getElementById('disciplineScore').textContent = Math.round(bh.discipline_score);
        document.getElementById('overtrading').textContent = '+' + bh.overtrading_pct + '%';
        document.getElementById('earlyExits').textContent = bh.early_exits;
        document.getElementById('earlyExitCost').textContent = '‚Çπ' + bh.early_exit_cost.toLocaleString();
        
        const insights = document.getElementById('behavioralInsights');
        insights.innerHTML = `
            <li>Discipline score: ${Math.round(bh.discipline_score)}/100 - ${bh.discipline_score > 75 ? 'Excellent!' : bh.discipline_score > 50 ? 'Good' : 'Needs improvement'}</li>
            <li>Overtrading penalty: ${bh.overtrading_pct}%</li>
            <li>Early exits cost: ‚Çπ${bh.early_exit_cost.toLocaleString()}</li>
        `;
    } else {
        document.getElementById('behavioralSection').style.display = 'none';
    }
    
    // 10. Stress Testing
    if (data.stress_testing && data.stress_testing.scenarios) {
        const stressBody = document.getElementById('stressBody');
        stressBody.innerHTML = data.stress_testing.scenarios.map(s => `
            <tr>
                <td class="font-semibold">${s.scenario}</td>
                <td>‚Çπ${s.current_value.toLocaleString()}</td>
                <td>‚Çπ${s.stressed_value.toLocaleString()}</td>
                <td class="negative">‚Çπ${Math.abs(s.loss_amount).toLocaleString()}</td>
                <td class="negative">${s.loss_pct}%</td>
            </tr>
        `).join('');
    }
    
    // 11. TWR vs MWR
    if (data.twr_vs_mwr) {
        const tm = data.twr_vs_mwr;
        document.getElementById('twr').textContent = tm.time_weighted_return + '%';
        document.getElementById('mwr').textContent = tm.money_weighted_return + '%';
        document.getElementById('timingImpact').textContent = tm.timing_impact + '%';
        document.getElementById('timingImpact').className = 'text-2xl font-bold ' + (tm.timing_impact >= 0 ? 'text-green-600' : 'text-red-600');
        
        const explanation = `
            <strong>TWR (${tm.time_weighted_return}%):</strong> Your portfolio's performance (stock picking skill)<br>
            <strong>MWR (${tm.money_weighted_return}%):</strong> Your actual return (affected by timing)<br>
            <strong>Gap (${tm.timing_impact}%):</strong> ${tm.timing_impact >= 0 ? 'Good timing! You added money at right times' : 'Bad timing - you added money before drops'}
        `;
        document.getElementById('twrExplanation').innerHTML = explanation;
    }
    
    // 12. Tax
    if (data.tax_adjusted) {
        const tx = data.tax_adjusted;
        document.getElementById('preTaxGains').textContent = '‚Çπ' + tx.pre_tax_gains.toLocaleString();
        document.getElementById('totalTax').textContent = '‚Çπ' + Math.round(tx.total_tax).toLocaleString();
        document.getElementById('afterTaxGains').textContent = '‚Çπ' + Math.round(tx.after_tax_gains).toLocaleString();
        document.getElementById('taxEfficiency').textContent = tx.tax_efficiency + '%';
        document.getElementById('ltcgGains').textContent = '‚Çπ' + tx.ltcg_gains.toLocaleString();
        document.getElementById('ltcgTax').textContent = 'Tax: ‚Çπ' + tx.ltcg_tax.toLocaleString();
        document.getElementById('stcgGains').textContent = '‚Çπ' + tx.stcg_gains.toLocaleString();
        document.getElementById('stcgTax').textContent = 'Tax: ‚Çπ' + Math.round(tx.stcg_tax).toLocaleString();
        document.getElementById('taxBreakdown').textContent = `LTCG: ‚Çπ${tx.ltcg_tax.toLocaleString()} + STCG: ‚Çπ${Math.round(tx.stcg_tax).toLocaleString()}`;
    }
}

// Chart rendering functions (same as demo)
function renderEquityCurve(data) {
    const ctx = document.getElementById('equityCurveChart');
    if (equityCurveChart) equityCurveChart.destroy();
    
    equityCurveChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Portfolio Value',
                data: data.values,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return '‚Çπ' + (value/1000).toFixed(0) + 'K';
                        }
                    }
                }
            }
        }
    });
}

function renderDrawdownChart(equityCurve) {
    const values = equityCurve.values;
    const drawdowns = [];
    let runningMax = values[0];
    
    for (let v of values) {
        if (v > runningMax) runningMax = v;
        drawdowns.push(((v - runningMax) / runningMax) * 100);
    }
    
    const ctx = document.getElementById('drawdownChart');
    if (drawdownChart) drawdownChart.destroy();
    
    drawdownChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: equityCurve.dates,
            datasets: [{
                label: 'Drawdown %',
                data: drawdowns,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function renderAttribution(data) {
    const ctx = document.getElementById('attributionChart');
    if (attributionChart) attributionChart.destroy();
    
    attributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Market Effect', 'Stock Selection', 'Timing', 'Total Return'],
            datasets: [{
                label: 'Return %',
                data: [data.market_effect, data.stock_selection_effect, data.timing_effect, data.total_return],
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
    
    const details = document.getElementById('attributionDetails');
    details.innerHTML = `
        <div class="p-3 bg-blue-50 rounded">
            <div class="font-semibold text-blue-800">Market Effect: +${data.market_effect}%</div>
            <div class="text-sm text-gray-600">Return from overall market movement</div>
        </div>
        <div class="p-3 bg-green-50 rounded">
            <div class="font-semibold text-green-800">Stock Selection: +${data.stock_selection_effect}%</div>
            <div class="text-sm text-gray-600">Your skill in picking stocks</div>
        </div>
        <div class="p-3 bg-orange-50 rounded">
            <div class="font-semibold text-orange-800">Timing Effect: ${data.timing_effect}%</div>
            <div class="text-sm text-gray-600">Impact of entry/exit timing</div>
        </div>
        <div class="p-3 bg-purple-50 rounded border-2 border-purple-200">
            <div class="font-semibold text-purple-800">Total Return: +${data.total_return}%</div>
            <div class="text-sm text-gray-600">Combined effect of all factors</div>
        </div>
    `;
}

// Export functions
function exportToPDF() {
    alert('PDF export functionality will be implemented with a library like jsPDF');
}

function exportToExcel() {
    alert('Excel export functionality will be implemented with a library like SheetJS');
}

function shareReport() {
    if (navigator.share) {
        navigator.share({
            title: 'Performance Analytics Report',
            text: 'Check out my portfolio performance analysis!',
            url: window.location.href
        });
    } else {
        alert('Share functionality not supported on this browser');
    }
}
</script>

</body>
</html>
